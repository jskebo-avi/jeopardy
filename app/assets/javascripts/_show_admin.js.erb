$(function() {
	var evaluate = function(status, btn){
      	var clue = $(btn).attr("data-clue");
    	var answer = $(btn).attr("data-answer");
    	var color = status === 1 ? "chartreuse" : "tomato";
		var evalSuccessHandler = function(evalResponse) {
	      	$(btn).closest('tr').css("background-color", color);
	      	$(btn).parent().siblings('.current_score').text(evalResponse.new_user_score);
	      	var user = $(btn).parent().siblings().closest(".answer-user").text();

	      	var scoreSuccessHandler = function(scoreResponse){
	      		$(this).siblings('.current_score').text(scoreResponse.score);
	      		$(this).siblings('.previous_score').text(scoreResponse.prev_score);
	      	}
	      	
	      	$(".answer-user").each(function(){
	      		if($(this).text() === user){
	      			var answer_id = $(this).parent().attr("id") //tr

	      			$.ajax({
				      	url: "/answers/get_user_score",
				      	data: JSON.stringify({ answer: answer_id, user: user }),
				      	dataType: 'json',
				      	contentType: 'application/json',
				      	type: 'POST',
				    }).done($.proxy(scoreSuccessHandler, this))
				    .fail(function() {
				      	debugger;
				    });
	      		}
	      	})
	    };

	    $.ajax({
	      	url: "/answers/evaluate",
	      	data: JSON.stringify({ clue: clue, answer: answer, status: status }),
	      	dataType: 'json',
	      	contentType: 'application/json',
	      	type: 'POST',
	    }).done($.proxy(evalSuccessHandler, this))
	    .fail(function() {
	      	debugger;
	    });
	};
  	$('.btn_correct').click(function() {
  		evaluate(1, $(this));
  	});
	$('.btn_incorrect').click(function() {
		evaluate(-1, $(this));
  	});
});